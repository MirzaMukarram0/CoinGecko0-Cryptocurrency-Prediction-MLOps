# ============================================================================
# DEV BRANCH - CODE QUALITY WORKFLOW (Feature â†’ Dev)
# ============================================================================
# This workflow runs on PRs from feature branches to dev
# It performs code quality checks (linting) and unit tests
# CML Integration: N/A for this stage

name: Dev - Code Quality & Unit Tests

on:
  push:
    branches:
      - dev
      - 'feature/**'
  pull_request:
    branches:
      - dev

env:
  PYTHONPATH: ${{ github.workspace }}

jobs:
  # =========================================================================
  # Job 1: Code Quality Checks (Linting)
  # =========================================================================
  code-quality:
    name: ðŸ” Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install linting dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort bandit pylint

      - name: Run Flake8 (Linting)
        id: flake8
        run: |
          echo "ðŸ” Running Flake8 linting..."
          flake8 src/ airflow/dags/ \
            --max-line-length=120 \
            --exclude=__pycache__,venv,.venv \
            --ignore=E501,W503,E203,E402 \
            --statistics --count \
            --output-file=flake8-report.txt || true
          cat flake8-report.txt
          
          # Check for critical errors
          ERRORS=$(flake8 src/ airflow/dags/ --select=E9,F63,F7,F82 --count 2>/dev/null | tail -1 || echo "0")
          if [ "$ERRORS" != "0" ] && [ -n "$ERRORS" ]; then
            echo "âŒ Critical linting errors found!"
            exit 1
          fi
          echo "âœ… No critical linting errors"

      - name: Run Black (Code Formatting Check)
        run: |
          echo "ðŸŽ¨ Checking code formatting with Black..."
          black --check --diff src/ tests/ airflow/dags/ 2>&1 | head -50 || echo "::warning::Black formatting issues found"
        continue-on-error: true

      - name: Run isort (Import Sorting Check)
        run: |
          echo "ðŸ“¦ Checking import sorting with isort..."
          isort --check-only --diff src/ tests/ airflow/dags/ 2>&1 | head -50 || echo "::warning::Import sorting issues found"
        continue-on-error: true

      - name: Run Bandit (Security Check)
        run: |
          echo "ðŸ”’ Running security analysis with Bandit..."
          bandit -r src/ -ll -ii --exclude tests/ -f txt -o bandit-report.txt || true
          cat bandit-report.txt
        continue-on-error: true

      - name: Upload Linting Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: linting-reports
          path: |
            flake8-report.txt
            bandit-report.txt

  # =========================================================================
  # Job 2: Unit Tests
  # =========================================================================
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-mock
          pip install -r requirements.txt

      - name: Create test directories
        run: |
          mkdir -p data/raw data/processed data/models data/profiles

      - name: Run Unit Tests with Coverage
        run: |
          echo "ðŸ§ª Running Unit Tests..."
          pytest tests/ -v \
            --cov=src \
            --cov-report=xml:coverage.xml \
            --cov-report=term-missing \
            --junitxml=test-results.xml \
            || echo "::warning::Some tests failed"

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            test-results.xml
            coverage.xml

      - name: Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª Dev Branch CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Code Quality" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Flake8 linting passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security scan completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Unit Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Tests executed with coverage report" >> $GITHUB_STEP_SUMMARY
